---
import "../utils/error-logger";
import ProfileSelector from "../components/solid/ProfileSelector.tsx";
import { getServerApiClient } from "../utils/api-client";
import Layout from "./Layout.astro";

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	noindex?: boolean;
}

const { title = "Media Timeline", description, ogImage, noindex } = Astro.props;

const pathname = Astro.url.pathname;
const profileSlug = Astro.url.searchParams.get("profile");

const buildUrl = (path: string) => {
	if (!profileSlug) return path;
	return `${path}?profile=${encodeURIComponent(profileSlug)}`;
};

const user = Astro.locals.user;
const isAuthenticated = !!user;
let initialProfiles: { id: string; slug: string; name: string; description: string | null; created_at: string }[] = [];

if (isAuthenticated) {
	try {
		const client = getServerApiClient(Astro.locals);
		const profilesResult = await client.media.profiles.list();
		if (profilesResult.ok) {
			initialProfiles = profilesResult.value;
		}
	} catch {
	}
}
---

<Layout title={title} description={description} ogImage={ogImage} noindex={noindex}>
  <body>
    <div id="container">
      <header class="unified-header">
        <div class="unified-header__row1">
          <div class="unified-header__left">
            <a href="https://devpad.tools" class="unified-header__logo">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7.4"></path>
                <path d="M2 6h4"></path>
                <path d="M2 10h4"></path>
                <path d="M2 14h4"></path>
                <path d="M2 18h4"></path>
                <path d="M21.378 5.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"></path>
              </svg>
              <span>devpad</span>
            </a>
          </div>
          <nav class="unified-header__apps">
            <a href="https://devpad.tools/project" class="unified-header__app">projects</a>
            <a href="https://devpad.tools/todo" class="unified-header__app">tasks</a>
            <a href="https://blog.devpad.tools" class="unified-header__app">blog</a>
            <a href="/dashboard" class="unified-header__app active">media</a>
            <a href="https://devpad.tools/docs" class="unified-header__app">docs</a>
          </nav>
          <div class="unified-header__auth">
            {user ? (
              <span class="user-name">{user.name || user.email || "User"}</span>
            ) : (
              <a href="/api/auth/login">login</a>
            )}
          </div>
        </div>
        <div class="unified-header__row2">
          <nav class="unified-header__subnav">
            <a href={buildUrl("/dashboard")} class:list={[{ active: pathname.startsWith("/dashboard") }]}>dashboard</a>
            <a href={buildUrl("/timeline")} class:list={[{ active: pathname.startsWith("/timeline") }]}>timeline</a>
            <a href={buildUrl("/connections")} class:list={[{ active: pathname.startsWith("/connections") }]}>connections</a>
          </nav>
          <div class="unified-header__controls">
            <ProfileSelector
              client:load
              currentSlug={profileSlug}
              initialProfiles={initialProfiles}
              isAuthenticated={isAuthenticated}
            />
          </div>
        </div>
      </header>
      <main class="flex-col">
        <slot />
      </main>
    </div>
    <footer>
      <p class="description">media.devpad.tools</p>
    </footer>
  </body>
</Layout>
