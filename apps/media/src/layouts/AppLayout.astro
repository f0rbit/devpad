---
import "../utils/error-logger";
import ProfileSelector from "../components/solid/ProfileSelector.tsx";
import { DevpadHeader, DevpadFooter } from "@devpad/core/ui";
import { getServerApiClient } from "@devpad/core/ui/api-client";
import Layout from "./Layout.astro";

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	noindex?: boolean;
}

const { title = "Media Timeline", description, ogImage, noindex } = Astro.props;

const pathname = Astro.url.pathname;
const profileSlug = Astro.url.searchParams.get("profile");

const buildUrl = (path: string) => {
	if (!profileSlug) return path;
	return `${path}?profile=${encodeURIComponent(profileSlug)}`;
};

const user = Astro.locals.user;
const isAuthenticated = !!user;
let initialProfiles: { id: string; slug: string; name: string; description: string | null; created_at: string }[] = [];

if (isAuthenticated) {
	try {
		const client = getServerApiClient(Astro.locals);
		const profilesResult = await client.media.profiles.list();
		if (profilesResult.ok) {
			initialProfiles = profilesResult.value;
		}
	} catch {
	}
}
---

<Layout title={title} description={description} ogImage={ogImage} noindex={noindex}>
	<body>
		<div id="container">
			<header class="unified-header">
				<DevpadHeader client:load currentApp="media" user={user} />
				<div class="unified-header__row2">
					<nav class="unified-header__subnav">
						<a href={buildUrl("/dashboard")} class:list={[{ active: pathname.startsWith("/dashboard") }]}>dashboard</a>
						<a href={buildUrl("/timeline")} class:list={[{ active: pathname.startsWith("/timeline") }]}>timeline</a>
						<a href={buildUrl("/connections")} class:list={[{ active: pathname.startsWith("/connections") }]}>connections</a>
					</nav>
					<div class="unified-header__controls">
						<ProfileSelector
							client:load
							currentSlug={profileSlug}
							initialProfiles={initialProfiles}
							isAuthenticated={isAuthenticated}
						/>
					</div>
				</div>
			</header>
			<main class="flex-col">
				<slot />
			</main>
		</div>
		<DevpadFooter client:load text="media.devpad.tools" />
	</body>
</Layout>
