---
import { getServerApiClient } from "@devpad/core/ui/api-client";
import { rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import HistoryTimeline from "@/components/solid/HistoryTimeline";
import ApiKeyManager from "@/components/solid/ApiKeyManager";

const user = Astro.locals.user;

if (!user) {
	return new Response(null, { status: 401, statusText: "Unauthorized" });
}

const client = getServerApiClient(Astro.locals);

const [keys_result, history_result] = await Promise.all([
	client.auth.keys.list(),
	client.user.history(),
]);
if (!keys_result.ok) return rethrow(keys_result.error);
const keys = keys_result.value;

if (!history_result.ok) return rethrow(history_result.error);
const user_history = history_result.value;
---

<PageLayout title="Account - devpad">
	<div class="flex-col" style="gap: 15px;">
		<a href="/api/auth/logout" style="width: min-content;">logout</a>
		<br />
		<ApiKeyManager keys={keys} client:load />
		<br />
		<h3>history</h3>
		<HistoryTimeline actions={user_history} view="account" client:load />
	</div>
</PageLayout>
