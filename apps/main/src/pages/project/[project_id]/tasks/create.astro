---
import { getProject, rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectTasksLayout from "@/layouts/ProjectTasksLayout.astro";
import TaskEditor from "@/components/solid/TaskEditor";

const project_id = Astro.params.project_id!;

const guard = await getProject(Astro);
if (guard instanceof Response) return guard;
const { client, project, user } = guard;

const goal_id_param = Astro.url.searchParams.get("goal_id") || null;

const [map_result, tags_result] = await Promise.all([
	client.projects.map(),
	client.tags.list(),
]);
if (!map_result.ok) return rethrow(map_result.error);
const project_map = map_result.value;

if (!tags_result.ok) return rethrow(tags_result.error);
const user_tags = tags_result.value;
---

<PageLayout title={`New Task - ${project_id}`}>
	<ProjectTasksLayout project_id={project_id}>
		<TaskEditor
			task={null}
			user_tags={user_tags}
			current_tags={[]}
			history={[]}
			user_id={user.id}
			project_map={project_map}
			default_project_id={project.id}
			default_goal_id={goal_id_param}
			client:load
		/>
	</ProjectTasksLayout>
</PageLayout>
