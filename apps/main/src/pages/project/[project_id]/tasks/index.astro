---
import { getServerApiClient, rethrow } from "@/utils/api-client";
import type { Project } from "@devpad/schema";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectTasksLayout from "@/layouts/ProjectTasksLayout.astro";
import { TaskSorter } from "@/components/solid/TaskSorter";

const { project_id } = Astro.params;
if (!project_id) return new Response(null, { status: 404, statusText: "Project not found" });
const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const apiClient = getServerApiClient(Astro.locals);

const project_result = await apiClient.projects.getByName(project_id);
if (!project_result.ok) return rethrow(project_result.error);
const project = project_result.value;
if (!project) return new Response(null, { status: 404, statusText: "Project not found" });
if (project.owner_id !== user.id) return new Response(null, { status: 401, statusText: "Access denied" });

const project_map = {} as Record<string, Project>;
project_map[project.id] = project;

const tasks_result = await apiClient.tasks.getByProject(project.id);
if (!tasks_result.ok) return rethrow(tasks_result.error);
const tasks = tasks_result.value;

const tags_result = await apiClient.tags.list();
if (!tags_result.ok) return rethrow(tags_result.error);
const tags = tags_result.value;
---

<PageLayout title={`Tasks - ${project_id}`}>
	<ProjectTasksLayout project_id={project_id}>
		<TaskSorter client:load tasks={tasks} project_map={project_map} defaultOption={"recent"} tags={tags} user_id={user.id} defaultView={user.task_view || "list"} />
	</ProjectTasksLayout>
</PageLayout>
