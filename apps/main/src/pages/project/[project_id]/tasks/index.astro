---
import { getProject, rethrow } from "@/utils/api-client";
import type { Project } from "@devpad/schema";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectTasksLayout from "@/layouts/ProjectTasksLayout.astro";
import { TaskSorter } from "@/components/solid/TaskSorter";

const project_id = Astro.params.project_id!;

const guard = await getProject(Astro);
if (guard instanceof Response) return guard;
const { client, project, user } = guard;

const project_map = { [project.id]: project } as Record<string, Project>;

const [tasks_result, tags_result] = await Promise.all([
	client.tasks.getByProject(project.id),
	client.tags.list(),
]);
if (!tasks_result.ok) return rethrow(tasks_result.error);
const tasks = tasks_result.value;

if (!tags_result.ok) return rethrow(tags_result.error);
const tags = tags_result.value;
---

<PageLayout title={`Tasks - ${project_id}`}>
	<ProjectTasksLayout project_id={project_id}>
		<TaskSorter client:load tasks={tasks} project_map={project_map} defaultOption={"recent"} tags={tags} user_id={user.id} defaultView={user.task_view || "list"} />
	</ProjectTasksLayout>
</PageLayout>
