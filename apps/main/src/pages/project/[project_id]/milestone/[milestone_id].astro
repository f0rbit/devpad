---
import { getServerApiClient } from "@devpad/core/ui/api-client";
import { rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectLayout from "@/layouts/ProjectLayout.astro";


const { project_id, milestone_id } = Astro.params;
if (!project_id || !milestone_id) return new Response(null, { status: 404, statusText: "Not found" });

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const apiClient = getServerApiClient(Astro.locals);

const project_result = await apiClient.projects.getByName(project_id);
if (!project_result.ok) return rethrow(project_result.error);
const project = project_result.value;
if (!project) return new Response(null, { status: 404, statusText: "Project not found" });
if (project.owner_id !== user.id) return new Response(null, { status: 401, statusText: "Access denied" });

const milestone_result = await apiClient.milestones.find(milestone_id);
if (!milestone_result.ok) return rethrow(milestone_result.error);
const milestone = milestone_result.value;
if (!milestone) return new Response(null, { status: 404, statusText: "Milestone not found" });
---

<PageLayout title={`Edit Milestone - ${project_id}`}>
	<ProjectLayout project_id={project_id}>
		<h4 class="font-medium" style="margin: 0;">Edit milestone</h4>
		<section class="stack" id="milestone-form" data-project-id={project.id} data-milestone-id={milestone.id}>
			<div class="form-field">
				<label class="form-field-label" for="name">Name <span class="form-field-required">*</span></label>
				<input id="name" class="input" type="text" value={milestone.name} placeholder="Milestone name" required />
			</div>

			<div class="form-field">
				<label class="form-field-label" for="description">Description</label>
				<textarea id="description" class="textarea" placeholder="Optional description" rows={3}>{milestone.description || ""}</textarea>
			</div>

			<div class="form-field">
				<label class="form-field-label" for="target-version">Target version</label>
				<input id="target-version" class="input" type="text" value={milestone.target_version || ""} placeholder="e.g., v1.0.0" />
			</div>

			<div class="form-field">
				<label class="form-field-label" for="target-time">Target date</label>
				<input id="target-time" class="input" type="date" value={milestone.target_time ? milestone.target_time.split('T')[0] : ""} />
			</div>

			<div class="row-between">
				<div class="row" style="gap: 0.5rem;">
					<button type="button" id="submit-milestone" class="btn">Update Milestone</button>
					<button type="button" id="cancel-milestone" class="btn btn-secondary">Cancel</button>
				</div>
				<button type="button" id="delete-milestone" class="btn btn-danger">Delete</button>
			</div>

			<p id="error" class="form-field-error" style="display: none;"></p>
		</section>
	</ProjectLayout>
</PageLayout>

<script>
	import { getBrowserClient } from "@devpad/core/ui/client";

	async function updateMilestone() {
		const errorEl = document.getElementById("error") as HTMLParagraphElement;
		errorEl.style.display = "none";
		errorEl.innerText = "";

		const getValue = (id: string) => {
			return (document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement)?.value?.trim() || null;
		};

		const name = getValue("name");
		const description = getValue("description");
		const target_version = getValue("target-version");
		const target_time = getValue("target-time") ? getValue("target-time") + "T00:00:00.000Z" : null;
		
		if (!name) {
			errorEl.innerText = "Milestone name is required";
			errorEl.style.display = "block";
			return;
		}

		const milestoneId = document.getElementById("milestone-form")?.dataset.milestoneId;
		if (!milestoneId) {
			errorEl.innerText = "Milestone ID not found";
			errorEl.style.display = "block";
			return;
		}

		try {
			const apiClient = getBrowserClient();
		await apiClient.milestones.update(milestoneId, {
			name,
			description: description ?? undefined,
			target_version: target_version ?? undefined,
			target_time: target_time ?? undefined,
		});

			const projectSlug = window.location.pathname.split('/')[2];
			window.location.href = `/project/${projectSlug}/goals`;
		} catch (error) {
			console.error("Failed to update milestone:", error);
			errorEl.innerText = "Failed to update milestone";
			errorEl.style.display = "block";
		}
	}

	async function deleteMilestone() {
		if (!confirm("Are you sure you want to delete this milestone? This will also delete all its goals.")) {
			return;
		}

		const errorEl = document.getElementById("error") as HTMLParagraphElement;
		errorEl.style.display = "none";
		errorEl.innerText = "";

		const milestoneId = document.getElementById("milestone-form")?.dataset.milestoneId;
		if (!milestoneId) {
			errorEl.innerText = "Milestone ID not found";
			errorEl.style.display = "block";
			return;
		}

		try {
			const apiClient = getBrowserClient();
			await apiClient.milestones.delete(milestoneId);

			const projectSlug = window.location.pathname.split('/')[2];
			window.location.href = `/project/${projectSlug}/goals`;
		} catch (error) {
			console.error("Failed to delete milestone:", error);
			errorEl.innerText = "Failed to delete milestone";
			errorEl.style.display = "block";
		}
	}

	function cancelMilestone() {
		const projectSlug = window.location.pathname.split('/')[2];
		window.location.href = `/project/${projectSlug}/goals`;
	}

	document.getElementById("submit-milestone")?.addEventListener("click", updateMilestone);
	document.getElementById("cancel-milestone")?.addEventListener("click", cancelMilestone);
	document.getElementById("delete-milestone")?.addEventListener("click", deleteMilestone);
</script>
