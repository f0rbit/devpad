---
import { getServerApiClient, rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectLayout from "@/layouts/ProjectLayout.astro";


const { project_id } = Astro.params;
if (!project_id) return new Response(null, { status: 404, statusText: "Not found" });

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const apiClient = getServerApiClient(Astro.locals);

const project_result = await apiClient.projects.getByName(project_id);
if (!project_result.ok) return rethrow(project_result.error);
const project = project_result.value;
if (!project) return new Response(null, { status: 404, statusText: "Project not found" });
if (project.owner_id !== user.id) return new Response(null, { status: 401, statusText: "Access denied" });
---

<PageLayout title={`New Milestone - ${project_id}`}>
	<ProjectLayout project_id={project_id}>
		<h5>create milestone</h5>
		<section id="milestone-form" data-project-id={project.id}>
			<div class="flex-row">
				<label for="name">name</label>
				<input id="name" type="text" placeholder="Milestone name" required />
			</div>

			<div class="flex-row">
				<label for="description">description</label>
				<textarea id="description" placeholder="Optional description" rows={3}></textarea>
			</div>

			<div class="flex-row">
				<label for="target-version">target version</label>
				<input id="target-version" type="text" placeholder="e.g., v1.0.0" />
			</div>

			<div class="flex-row">
				<label for="target-time">target date</label>
				<input id="target-time" type="date" />
			</div>

			<div class="flex-row">
				<a role="button" id="submit-milestone">Create Milestone</a>
				<a role="button" id="cancel-milestone">Cancel</a>
			</div>

			<div>
				<p id="error" style="color: red;"></p>
			</div>
		</section>
	</ProjectLayout>
</PageLayout>

<script>
	import { getApiClient } from "@/utils/api-client";

	async function createMilestone() {
		const errorEl = document.getElementById("error") as HTMLParagraphElement;
		errorEl.innerText = "";

		const getValue = (id: string) => {
			return (document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement)?.value?.trim() ?? null;
		};

		const name = getValue("name");
		const description = getValue("description");
		const target_version = getValue("target-version");
		const tt = getValue("target-time");
		const target_time = tt ? tt + "T00:00:00.000Z" : undefined;
		
		if (!name) {
			errorEl.innerText = "Milestone name is required";
			return;
		}

		const projectId = document.getElementById("milestone-form")?.dataset.projectId;
		if (!projectId) {
			errorEl.innerText = "Project ID not found";
			return;
		}

		try {
			const apiClient = getApiClient();
			const result = await apiClient.milestones.create({
				name,
				description,
				target_version,
				target_time,
				project_id: projectId,
			});

			if (!result.ok) {
				console.error("Failed to create milestone:", result.error);
				errorEl.innerText = result.error.message || "Failed to create milestone";
				return;
			}

			// Navigate back to goals page
			const projectSlug = window.location.pathname.split('/')[2];
			window.location.href = `/project/${projectSlug}/goals`;
		} catch (error) {
			console.error("Failed to create milestone:", error);
			errorEl.innerText = "Failed to create milestone";
		}
	}

	function cancelMilestone() {
		const projectSlug = window.location.pathname.split('/')[2];
		window.location.href = `/project/${projectSlug}/goals`;
	}

	document.getElementById("submit-milestone")?.addEventListener("click", createMilestone);
	document.getElementById("cancel-milestone")?.addEventListener("click", cancelMilestone);
</script>
