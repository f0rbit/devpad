---
import { getServerApiClient, rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectLayout from "@/layouts/ProjectLayout.astro";
import { TaskSorter } from "@/components/solid/TaskSorter";

const { project_id, milestone_id, goal_id } = Astro.params;
if (!project_id || !milestone_id || !goal_id) {
	return new Response(null, { status: 404, statusText: "Invalid parameters" });
}

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const apiClient = getServerApiClient(Astro.locals);

const project_result = await apiClient.projects.getByName(project_id);
if (!project_result.ok) return rethrow(project_result.error);
const project = project_result.value;
if (!project) return new Response(null, { status: 404, statusText: "Project not found" });
if (project.owner_id !== user.id) return new Response(null, { status: 403, statusText: "Access denied" });

const milestone_result = await apiClient.milestones.find(milestone_id);
if (!milestone_result.ok) return rethrow(milestone_result.error);
const milestone = milestone_result.value;
if (!milestone) return new Response(null, { status: 404, statusText: "Milestone not found" });

const goal_result = await apiClient.goals.find(goal_id);
if (!goal_result.ok) return rethrow(goal_result.error);
const goal = goal_result.value;
if (!goal) return new Response(null, { status: 404, statusText: "Goal not found" });

if (goal.milestone_id !== milestone.id) {
	return new Response(null, { status: 400, statusText: "Goal does not belong to this milestone" });
}

const project_map: Record<string, typeof project> = {};
project_map[project.id] = project;

const tasks_result = await apiClient.tasks.list();
if (!tasks_result.ok) return rethrow(tasks_result.error);
const allTasks = tasks_result.value;

const tags_result = await apiClient.tags.list();
if (!tags_result.ok) return rethrow(tags_result.error);
const tags = tags_result.value;

const tasks = allTasks?.filter(task => task.task.goal_id === goal_id) || [];

const totalTasks = tasks.length;
const completedTasks = tasks.filter(task => task.task.progress === "COMPLETED").length;
const inProgressTasks = tasks.filter(task => task.task.progress === "IN_PROGRESS").length;
const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

const targetDate = goal.target_time ? new Date(goal.target_time).toLocaleDateString() : null;
const isOverdue = goal.target_time && new Date(goal.target_time) < new Date() && !goal.finished_at;
---

<PageLayout title={`${goal.name} - ${project_id}`}>
	<ProjectLayout project_id={project_id}>
		<div class="breadcrumb">
			<a href={`/project/${project_id}/milestone/${milestone_id}`}>{milestone.name}</a>
			<span>-&gt;</span>
			<span>{goal.name}</span>
		</div>

		<div class="card">
			<div class="card-header">
				<div class="row" style="gap: 0.75rem; align-items: center;">
					<h3 class="card-title">{goal.name}</h3>
					{goal.finished_at && <span class="badge badge-success">Completed</span>}
					{!goal.finished_at && isOverdue && <span class="badge badge-error">Overdue</span>}
				</div>
				{targetDate && (
					<div class="row text-sm text-muted" style="gap: 0.25rem; margin-top: 0.25rem;">
						<span class={isOverdue ? "overdue-text" : ""}>Target: {targetDate}</span>
					</div>
				)}
			</div>
			<div class="card-content">
				<div class="row" style="gap: 1.5rem;">
					<div class="stat">
						<span class="stat-value">{progressPercentage}%</span>
						<span class="stat-label">Complete</span>
					</div>
					<div class="stat">
						<span class="stat-value">{completedTasks}/{totalTasks}</span>
						<span class="stat-label">Tasks done</span>
					</div>
					{inProgressTasks > 0 && (
						<div class="stat">
							<span class="stat-value">{inProgressTasks}</span>
							<span class="stat-label">In progress</span>
						</div>
					)}
				</div>
				<div class="progress-bar">
					<div class="progress-fill" style={`width: ${progressPercentage}%`}></div>
				</div>
				{goal.description && (
					<p class="text-sm text-muted" style="margin: 0;">{goal.description}</p>
				)}
			</div>
		</div>

		<div style="margin-top: 1.5rem;">
			{totalTasks > 0 ? (
				<TaskSorter
					client:load
					tasks={tasks}
					project_map={project_map}
					defaultOption="upcoming"
					tags={tags}
					user_id={user.id}
					defaultView={user.task_view || "list"}
				/>
			) : (
				<div class="empty">
					<h3 class="empty-title">No tasks yet</h3>
					<p class="empty-description">Create a task and assign it to this goal.</p>
					<a href={`/project/${project_id}/tasks/create?goal_id=${goal_id}`} class="btn">Create task</a>
				</div>
			)}
		</div>
	</ProjectLayout>
</PageLayout>

<style>
	.breadcrumb {
		font-size: var(--text-sm);
		color: var(--fg-muted);
		margin-bottom: 1rem;
	}
	.breadcrumb a {
		color: var(--fg);
		text-decoration: none;
	}
	.breadcrumb a:hover {
		text-decoration: underline;
	}
	.breadcrumb span {
		margin: 0 0.25rem;
	}
	.progress-bar {
		width: 100%;
		height: 6px;
		background: var(--border);
		border-radius: 3px;
		overflow: hidden;
		margin-top: 1rem;
	}
	.progress-fill {
		height: 100%;
		background: var(--accent);
		transition: width 0.3s ease;
	}
	.overdue-text {
		color: var(--error);
		font-weight: 500;
	}
</style>
