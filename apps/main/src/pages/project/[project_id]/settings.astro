---
import { getProject, rethrow } from "@/utils/api-client";
import PageLayout from "../../../layouts/PageLayout.astro";
import ProjectLayout from "../../../layouts/ProjectLayout.astro";
import ProjectSettings from "../../../components/ProjectSettings.astro";
import ConfigEditor from "../../../components/solid/ConfigEditor";

const project_id = Astro.params.project_id!;

const guard = await getProject(Astro);
if (guard instanceof Response) return guard;
const { client, project } = guard;

const [config_result, tags_result] = await Promise.all([
	client.projects.config.load(project.id),
	client.tags.list(),
]);
if (!config_result.ok) return rethrow(config_result.error);
const config = config_result.value;
if (!tags_result.ok) return rethrow(tags_result.error);
const available_tags = tags_result.value;

const [owner, repo] = project.repo_url ? project.repo_url.split("/").slice(-2) : [null, null];

let branches: any[] | null = null;
if (owner && repo) {
	const branches_result = await client.github.branches(owner, repo);
	if (branches_result.ok) {
		branches = branches_result.value;
	}
}
---

<PageLayout title={`Settings - ${project_id}`}>
	<ProjectLayout project_id={project_id}>
		<div class="flex-col" style="gap: 5px">
			<h5>project settings</h5>
			<ProjectSettings project={project} />
			<br />
			<h5>scanning settings</h5>
			<ConfigEditor id={project.id} config={config.config} branches={branches} scan_branch={project.scan_branch} user_tags={available_tags} client:load />
		</div>
	</ProjectLayout>
</PageLayout>
