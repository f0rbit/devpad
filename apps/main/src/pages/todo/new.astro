---
import { getServerApiClient } from "@devpad/core/ui/api-client";
import { rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import TaskEditor from "@/components/solid/TaskEditor";

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const client = getServerApiClient(Astro.locals);

const [map_result, tags_result] = await Promise.all([
	client.projects.map(),
	client.tags.list(),
]);

if (!map_result.ok) return rethrow(map_result.error);
const project_map = map_result.value;

if (!tags_result.ok) return rethrow(tags_result.error);
const user_tags = tags_result.value;
---

<PageLayout title={"New Task - devpad"}>
	<main>
		<TaskEditor
			task={null}
			user_tags={user_tags}
			current_tags={[]}
			history={[]}
			user_id={user.id}
			project_map={project_map}
			client:load
		/>
	</main>
</PageLayout>
