---
import type { Project, TagWithTypedColor, TaskWithDetails } from "@devpad/schema";
import Plus from "lucide-solid/icons/plus";
import Tag from "lucide-solid/icons/tag";
import GithubLogin from "@/components/solid/GithubLogin";
import { TaskSorter } from "@/components/solid/TaskSorter";
import PageLayout from "@/layouts/PageLayout.astro";
import { getServerApiClient } from "@devpad/core/ui/api-client";
import { rethrow } from "@/utils/api-client";

let user = Astro.locals.user;

let project_map: Record<string, Project> = {};
let tasks: TaskWithDetails[] = [];
let tags: TagWithTypedColor[] = [];

if (user) {
	try {
		const api_client = getServerApiClient(Astro.locals);

		// Get projects list and convert to map format
		const project_map_result = await api_client.projects.map();
		if (!project_map_result.ok) return rethrow(project_map_result.error);

		const tasks_result = await api_client.tasks.list();
		if (!tasks_result.ok) return rethrow(tasks_result.error);

		const tags_result = await api_client.tags.list();
		if (!tags_result.ok) return rethrow(tags_result.error);

		project_map = project_map_result.value;
		tasks = tasks_result.value;
		tags = tags_result.value;
	} catch (error) {
		// the error here is that the user is not logged in/authenticated.
		// which we can safely ignore since this is optional.
		user = null;
	}
}

const keywords = [
	// One-word keywords
	"tasks",
	"todo",
	"tracking",
	"priorities",
	"automation",

	// Two-word keywords
	"task management",
	"todo tracking",
	"code scanning",
	"task priorities",
	"due dates",
	"task automation",
	"task filtering",
	"todo comments",
	"task updates",
	"task editor",
	"task organization",
	"project tasks",
	"task integration",
	"task visibility",
	"task progress",

	// Three-word keywords
	"todo comment scanning",
	"task priority management",
	"codebase task tracking",
	"task organization tools",
	"task management system",
];
---

<PageLayout
	title="Tasks - devpad"
	description="Streamline your task management with devpad. Track, organize, and prioritize tasks effortlessly. Automatically scan your codebase for TODO comments, assign priorities, set due dates, and integrate seamlessly with your projects."
	keywords={keywords}
	canonical="https://devpad.tools/todo"
>
	{
		user ? (
			<main>
				<div class="flex-row">
					<h3>upcoming tasks</h3>
					<a href="/todo/new" style="font-size: small;" class="flex-row">
						<Plus />
						new task
					</a>
					<a href="/todo/tags" style="margin-left: auto; font-size: small;" class="flex-row">
						<Tag />
						tags
					</a>
				</div>
				<TaskSorter client:load tasks={tasks} project_map={project_map} defaultOption={"upcoming"} tags={tags} user_id={user.id} defaultView={user.task_view || "list"} />
				<br />
				<br />
			</main>
		) : (
			<main>
				<section class="landing-hero">
					<div class="dot-grid"></div>
					<h1 style="font-size: 2.5rem; font-weight: 600; margin: 0;">keep track.</h1>
					<p class="text-lg text-muted hero-description">
						scan your codebase for @todo comments and turn them into real, trackable tasks. automatic detection, smart tagging, priority assignment, and diff-based updates.
					</p>
					<GithubLogin client:load />
				</section>

				<section class="landing-section">
					<h2 class="section-title text-xl font-bold">features</h2>
					<div class="grid grid-2">
						<div class="card card-flat">
							<div class="row" style="gap: var(--space-sm); margin-bottom: var(--space-sm);">
								<span class="card-icon">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
								</span>
								<h3 class="card-title">Codebase Scanning</h3>
							</div>
							<p class="card-description">connect a GitHub repository and devpad scans for TODO, FIXME, and @todo comments. when code around a comment changes, you see the diff.</p>
						</div>
						<div class="card card-flat">
							<div class="row" style="gap: var(--space-sm); margin-bottom: var(--space-sm);">
								<span class="card-icon">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
								</span>
								<h3 class="card-title">Smart Tagging</h3>
							</div>
							<p class="card-description">organize tasks with custom color-coded tags. filter by tag, project, or priority to find exactly what you need across all your work.</p>
						</div>
						<div class="card card-flat">
							<div class="row" style="gap: var(--space-sm); margin-bottom: var(--space-sm);">
								<span class="card-icon">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
								</span>
								<h3 class="card-title">Goals & Milestones</h3>
							</div>
							<p class="card-description">attach tasks to goals within project milestones. track completion rates and see how individual tasks contribute to larger releases.</p>
						</div>
						<div class="card card-flat">
							<div class="row" style="gap: var(--space-sm); margin-bottom: var(--space-sm);">
								<span class="card-icon">
									<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9m-9 9a9 9 0 0 1 9-9"/></svg>
								</span>
								<h3 class="card-title">API Access</h3>
							</div>
							<p class="card-description">every task is accessible via the REST API. build custom views, integrate with other tools, or use the MCP server to manage tasks through AI assistants.</p>
						</div>
					</div>
				</section>

				<section class="landing-section">
					<h2 class="section-title text-xl font-bold">your tasks at a glance</h2>
					<div class="card card-flat" style="padding: var(--space-lg);">
						<div class="stack" style="gap: var(--space-sm);">
							<div class="flex-col" style="gap: 3px;">
								<div>
									<span class="progress-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg></span>
									<span class="task-title">implement token refresh with retry logic</span>
								</div>
								<p class="task-summary">auth module needs graceful retry on token expiry</p>
								<div class="flex-col" style="font-size: small; gap: 6px;">
									<span class="flex-row priority-high">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
										<span>tomorrow</span>
									</span>
								</div>
							</div>
							<div class="flex-col" style="gap: 3px;">
								<div>
									<span class="progress-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="3"/></svg></span>
									<span class="task-title">add dark mode toggle to settings</span>
								</div>
								<p class="task-summary">settings page needs a theme switcher component</p>
								<div class="flex-col" style="font-size: small; gap: 6px;">
									<span class="flex-row priority-medium">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
										<span>next week</span>
									</span>
								</div>
							</div>
							<div class="flex-col" style="gap: 3px;">
								<div>
									<span class="progress-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg></span>
									<span class="task-title">write API documentation for v2</span>
								</div>
								<p class="task-summary">document all public endpoints with examples</p>
								<div class="flex-col" style="font-size: small; gap: 6px;">
									<span class="flex-row priority-none">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
										<span>no due date</span>
									</span>
								</div>
							</div>
							<div class="flex-col" style="gap: 3px;">
								<div>
									<span class="progress-icon"><div class="priority-low"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg></div></span>
									<span class="task-title" style="text-decoration: line-through; color: var(--fg-faint);">fix login redirect on oauth callback</span>
								</div>
								<p class="task-summary">oauth callback was redirecting to wrong page</p>
								<div class="flex-col" style="font-size: small; gap: 6px;">
									<span class="flex-row priority-high">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
										<span>yesterday</span>
									</span>
								</div>
							</div>
						</div>
					</div>
				</section>

				<section class="landing-section stack" style="text-align: center; align-items: center;">
					<h2 class="text-xl font-bold">ready to get organized?</h2>
					<p class="text-muted">sign in with GitHub to start tracking.</p>
					<GithubLogin client:load />
				</section>
			</main>
		)
	}
</PageLayout>

<style>
	.landing-hero {
		position: relative;
		text-align: center;
		max-width: 800px;
		margin: 0 auto;
		padding: 8rem var(--space-lg);
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--space-md);
	}

	.dot-grid {
		position: absolute;
		inset: 0;
		overflow: hidden;
		pointer-events: none;
		mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
		-webkit-mask-image: radial-gradient(ellipse 70% 50% at 50% 50%, black 20%, transparent 70%);
	}

	.dot-grid::before {
		content: "";
		position: absolute;
		inset: -50%;
		width: 200%;
		height: 200%;
		background-image: radial-gradient(circle at center, var(--border) 1.5px, transparent 1.5px);
		background-size: 32px 32px;
		opacity: 0.5;
		animation: dot-wave 25s linear infinite;
	}

	@keyframes dot-wave {
		0% { transform: translate(0, 0); }
		100% { transform: translate(32px, 32px); }
	}

	.hero-description {
		max-width: 500px;
		margin: 0;
	}

	.landing-section {
		max-width: 1000px;
		margin: 0 auto;
		padding: calc(var(--space-xl) * 1.5) var(--space-md);
		width: 100%;
		box-sizing: border-box;
		display: flex;
		flex-direction: column;
		gap: var(--space-lg);
	}

	.section-title {
		text-align: center;
		margin-bottom: 0;
	}

	@media (max-width: 768px) {
		.landing-hero {
			padding: 4rem var(--space-md);
		}
	}

	@media (max-width: 480px) {
		.landing-hero {
			padding: 3rem var(--space-sm);
		}
	}
</style>
