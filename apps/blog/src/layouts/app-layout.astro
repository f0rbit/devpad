---
import AuthStatus from "../components/layout/auth-status";
import { ssr } from "../lib/ssr";
import BaseLayout from "./base-layout.astro";

interface Props {
	title?: string;
}

const { title = "Blog" } = Astro.props;
const currentPath = Astro.url.pathname;

const navLinks = [
	{ href: "/posts", label: "posts" },
	{ href: "/categories", label: "categories" },
	{ href: "/settings", label: "settings" },
];

const isActive = (href: string) => {
	if (href === "/") return currentPath === "/";
	return currentPath.startsWith(href);
};

let authUser = null;
let authAuthenticated = false;

const runtime = Astro.locals.runtime;
const authResult = await ssr<{ authenticated: boolean; user: any }>("/api/auth/session", Astro.request, {}, runtime);
if (authResult.ok) {
	authAuthenticated = authResult.value.authenticated;
	authUser = authResult.value.user;
}
---

<BaseLayout title={title}>
	<div id="container" class="stack">
		<header>
			<nav>
				<a href="/" class:list={{ active: isActive("/") }}>blog</a>
				<span class="text-muted">|</span>
				{navLinks.map((link) => (
					<a href={link.href} class:list={{ active: isActive(link.href) }}>
						{link.label}
					</a>
				))}
			</nav>
			<AuthStatus client:load initialUser={authUser} initialAuthenticated={authAuthenticated} />
		</header>

		<main>
			<slot />
		</main>
	</div>

	<footer>
		<span class="text-sm text-muted">blog.devpad.tools</span>
	</footer>
</BaseLayout>
