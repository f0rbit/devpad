---
import PostEditor from "@/components/post/post-editor";
import AppLayout from "@/layouts/app-layout.astro";
import { getServerApiClient } from "@/lib/api-client";

interface CategoryNode {
	name: string;
	parent: string | null;
	children?: CategoryNode[];
}

interface Category {
	name: string;
	parent: string | null;
}

interface Project {
	id: string;
	name: string;
	project_id: string;
	description: string | null;
}

const flattenTree = (nodes: CategoryNode[]): Category[] => nodes.flatMap(n => [{ name: n.name, parent: n.parent }, ...flattenTree(n.children ?? [])]);

let categories: Category[] = [];
let projects: Project[] = [];

const client = getServerApiClient(Astro.locals);
const [catResult, projResult] = await Promise.all([
	client.blog.categories.tree(),
	client.projects.list(),
]);

if (catResult.ok) {
	categories = flattenTree(catResult.value.categories ?? []);
}

if (projResult.ok) {
	projects = projResult.value;
}
---

<AppLayout title="New Post">
	<section class="stack">
		<header>
			<h1 class="page-title row">
				<a href="/posts" title="Back to posts" class="back-arrow">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
				</a>
				New Post
			</h1>
		</header>

		<div id="editor-container">
			<PostEditor client:load categories={categories} projects={projects} />
		</div>
	</section>
</AppLayout>

<style>
	.back-arrow {
		display: flex;
		align-items: center;
		color: var(--text-muted);
	}
	.back-arrow:hover {
		color: var(--text-link);
	}
</style>


