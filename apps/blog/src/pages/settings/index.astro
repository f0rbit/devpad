---
import SettingsPage from "@/components/settings/settings-page";
import AppLayout from "@/layouts/app-layout.astro";
import { ssr } from "@/lib/ssr";
import type { AccessKey, User } from "@devpad/schema/blog";

type Token = Pick<AccessKey, "id" | "name" | "note" | "enabled" | "created_at">;

let user: User | null = null;
let tokens: Token[] = [];

const runtime = Astro.locals.runtime;
const [userResult, tokensResult] = await Promise.all([
	ssr<{ authenticated: boolean; user: User }>("/api/auth/session", Astro.request, {}, runtime),
	ssr<{ tokens?: Token[] }>("/api/v1/blog/tokens", Astro.request, {}, runtime),
]);

if (userResult.ok && userResult.value.authenticated) {
	user = userResult.value.user;
}

if (tokensResult.ok) {
	tokens = tokensResult.value.tokens ?? [];
}
---

<AppLayout title="Settings">
	<section class="stack">
		<header>
			<h1 class="page-title">Settings</h1>
		</header>
		<SettingsPage client:load initialUser={user} initialTokens={tokens} />
	</section>
</AppLayout>
