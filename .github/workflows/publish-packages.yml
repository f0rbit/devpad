name: Publish Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        type: boolean
        required: false
        default: false

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '24'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Get version from release tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Extract version from tag (e.g., v1.7.3 -> 1.7.3)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            # For manual dispatch, read from package.json
            VERSION=$(node -p "require('./packages/api/package.json').version")
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Publishing version: ${VERSION}"

      - name: Sync versions across packages
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          node scripts/sync-versions.js --version ${VERSION}

      - name: Build all packages
        run: |
          echo "Building packages in dependency order..."
          cd packages/schema && bun run build && cd ../..
          cd packages/api && bun run build && cd ../..
          cd packages/cli && bun run build && cd ../..
          cd packages/mcp && bun run build && cd ../..

      - name: Prepare packages for publishing
        run: |
          # Replace workspace:* with actual versions
          VERSION="${{ steps.version.outputs.version }}"
          for package in api cli mcp; do
            echo "Preparing @devpad/$package..."
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('packages/$package/package.json', 'utf8'));
              for (const depType of ['dependencies', 'devDependencies', 'peerDependencies']) {
                if (pkg[depType]) {
                  for (const dep in pkg[depType]) {
                    if (pkg[depType][dep] === 'workspace:*') {
                      if (dep.startsWith('@devpad/')) {
                        pkg[depType][dep] = '^${VERSION}';
                      }
                    }
                  }
                }
              }
              fs.writeFileSync('packages/$package/package.json', JSON.stringify(pkg, null, 2));
            "
          done

      - name: Publish @devpad/api
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/api
        run: npm publish --access public

      - name: Publish @devpad/cli
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/cli
        run: npm publish --access public

      - name: Publish @devpad/mcp
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/mcp
        run: npm publish --access public

      - name: Dry run - show what would be published
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN - Would publish:"
          for package in api cli mcp; do
            echo "  @devpad/$package@${{ steps.version.outputs.version }}"
            cd packages/$package && npm publish --dry-run --access public 2>&1 | head -20 && cd ../..
          done

      - name: Summary
        run: |
          echo "## ðŸ“¦ Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @devpad/api" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @devpad/cli" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… @devpad/mcp" >> $GITHUB_STEP_SUMMARY
