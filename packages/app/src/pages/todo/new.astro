---
import { getServerApiClient } from "@/utils/api-client";
import PageLayout from '@/layouts/PageLayout.astro';
import TaskEditor from '@/components/solid/TaskEditor';

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

let project_map = {};
let user_tags = [];

try {
	const apiClient = getServerApiClient(Astro.locals);
	
	// Get projects and convert to map format
	const projects = await apiClient.projects.list();
	project_map = projects.reduce((acc, project) => {
		acc[project.project_id] = project;
		return acc;
	}, {} as Record<string, any>);
	
	// Get tags using API client
	user_tags = await apiClient.tags.list();
} catch (error) {
	console.error("Error fetching user data:", error);
	project_map = {};
	user_tags = [];
}
---

<PageLayout title={"New Task - devpad"}>
	<main>
		<TaskEditor
			task={{ task: null, codebase_tasks: null, tags: [] }}
			user_tags={user_tags}
			current_tags={[]}
			history={[]}
			user_id={user.id}
			project_map={project_map}
			client:load
		/>
	</main>
</PageLayout>
