---
import { getServerApiClient } from "@/utils/api-client";
import PageLayout from '@/layouts/PageLayout.astro';
import ProjectLayout from '@/layouts/ProjectLayout.astro';
import HistoryTimeline from "@/components/solid/HistoryTimeline";

/** @idea scan history should be able to be inspected to see breakdown of changes and what we accepted/rejected */

const { project_id } = Astro.params;
if (!project_id) return new Response(null, { status: 404, statusText: "Project not found" });
const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const apiClient = getServerApiClient(Astro.locals);

let project;
let history = [];
try {
	project = await apiClient.projects.getByName(project_id);
	if (!project) {
		return new Response(null, { status: 404, statusText: "Project not found" });
	}
	if (project.owner_id !== user.id) {
		return new Response(null, { status: 403, statusText: "Access denied" });
	}

	// Get project history
	history = await apiClient.projects.history(project_id);
} catch (error) {
	console.error("Failed to load project history:", error);
	return new Response(null, { status: 500, statusText: "Failed to load project data" });
}
---

<PageLayout title={`History - ${project_id}`}>
	<ProjectLayout project_id={project_id}>
		<h5>timeline</h5>
		<br />
		<HistoryTimeline actions={history} view="project" client:load />
	</ProjectLayout>
</PageLayout>
