---
import { getServerApiClient, rethrow } from "@/utils/api-client";
import PageLayout from "@/layouts/PageLayout.astro";
import ProjectTasksLayout from "@/layouts/ProjectTasksLayout.astro";
import TaskEditor from "@/components/solid/TaskEditor";

const { project_id } = Astro.params;
if (!project_id) return new Response(null, { status: 404, statusText: "Project not found" });
const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401, statusText: "Unauthorized" });

const api_client = getServerApiClient(Astro.locals);

// Get the project to verify access and pre-select it
const { project, error: project_error } = await api_client.projects.getByName(project_id);
if (project_error) return rethrow(project_error);
if (!project) return new Response(null, { status: 404, statusText: "Project not found" });
if (project.owner_id !== user.id) return new Response(null, { status: 401, statusText: "Access denied" });

// Create project map with just this project for the TaskEditor
const { project_map, error: map_error } = await api_client.projects.map();
if (map_error) return rethrow(map_error);

// Get user tags for the task editor
const { tags: user_tags, error: tags_error } = await api_client.tags.list();
if (tags_error) return rethrow(tags_error);
---

<PageLayout title={`New Task - ${project_id}`}>
	<ProjectTasksLayout project_id={project_id}>
		<TaskEditor
			task={null}
			user_tags={user_tags}
			current_tags={[]}
			history={[]}
			user_id={user.id}
			project_map={project_map}
			default_project_id={project_id}
			client:load
		/>
	</ProjectTasksLayout>
</PageLayout>
